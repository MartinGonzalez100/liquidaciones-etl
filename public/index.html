<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interfaz ETL de Liquidaciones</title>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <style>
        /* Tus estilos CSS existentes aqu√≠ */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f9; }
        .sidebar { height: 100%; width: 0; position: fixed; z-index: 10; top: 0; left: 0; background-color: #333; overflow-x: hidden; transition: 0.5s; padding-top: 60px; white-space: nowrap; }
        .sidebar a { padding: 8px 8px 8px 32px; text-decoration: none; font-size: 18px; color: #f1f1f1; display: block; transition: 0.3s; }
        .sidebar a:hover { color: #fff; background-color: #5c67f2; }
        .sidebar .closebtn { position: absolute; top: 0; right: 25px; font-size: 36px; margin-left: 50px; }
        .main-content { transition: margin-left .5s; padding: 20px; margin-left: 0; }
        .menu-btn { font-size: 30px; cursor: pointer; background-color: #5c67f2; color: white; padding: 5px 10px; border: none; border-radius: 4px; margin-bottom: 20px; display: block; }
        .container { max-width: 100%; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #5c67f2; padding-bottom: 10px; }
        .mode-selection { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #5c67f2; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #4a54e1; }
        #status-message { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .status-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .info { font-size: 0.9em; color: #666; margin-left: 20px; font-weight: normal; }
        #table-container { overflow-x: auto; margin-top: 20px; }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    
</head>
<body>
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">√ó</a>
        <h2>Men√∫ de Procesos</h2>
        <a href="#" onclick="showSection('conversion-form'); closeNav()">Inicio (Conversi√≥n)</a>
        <a href="#" id="menu-liquidacion-completa">Liquidaci√≥n Completa</a> 
        <a href="#" id="menu-acumulado"><i class="fas fa-calculator"></i> Acumulado Aporte Jub.</a>
        <a href="#" id="menu-residentes">Residentes</a>
        <a href="#" id="menu-ley100">Ley 100%</a>
        <a href="#" onclick="alert('Funcionalidad: Pago Familiar Discapacitado')">Pago Familiar Discapacitado</a>
        <a href="#" id="menu-prueba-csv" onclick="closeNav()">Prueba CSV Simple</a>
    </div>
    <div id="section-acumulado" style="display:none; margin-bottom: 20px;">
        <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; position: sticky; top: 10px; z-index: 100;">
            <label for="input-tope"><b>Tope Jubilatorio ($):</b></label>
            <input type="number" id="input-tope" placeholder="Ingrese valor..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <button id="btn-generar-acumulado" class="btn-convertir" style="margin:0; padding: 8px 20px;">Generar Listado</button>
        </div>
    </div>

    <div id="main-content" class="main-content">
        <button class="menu-btn" onclick="openNav()">‚ò∞ Men√∫</button>
        
        <div id="conversion-form" class="container">
            <h1>Procesador de Lotes de Liquidaciones</h1>

            <div class="mode-selection">
                <h2>Modo de Carga</h2>
                <label>
                    <input type="radio" name="processMode" value="default" checked onchange="toggleUpload(false)">
                    Usar archivos de la carpeta: <code>excel-a-convertir/</code>
                    <span class="info">(Procesa todos los archivos `.xlsx` que ya est√©n ah√≠)</span>
                </label>
                <label>
                    <input type="radio" name="processMode" value="upload" onchange="toggleUpload(true)">
                    Cargar archivos Excel ahora
                    <span class="info">(Mueve los archivos cargados a la carpeta por defecto para su procesamiento)</span>
                </label>
            </div>
            
            <div id="upload-area" style="display: none; margin-bottom: 20px;">
                <label for="file-input">Seleccionar Archivos Excel (.xlsx/.xls):</label>
                <input type="file" id="file-input" name="excelFiles" accept=".xlsx,.xls" multiple>
            </div>

            <button onclick="iniciarProceso()">Iniciar Conversi√≥n y Unificaci√≥n</button>

            <div id="status-message">
                <span id="status-text">Esperando para iniciar el proceso...</span>
                <span id="loading-dots" style="color: #1f202c; display: none; font-size: 25px;"></span> 
            </div>
        </div>

        <div id="panel-tope-jubilatorio" style="display:none; background: #fdfdfd; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 25px; border-left: 6px solid #4e73df;">
            <h3 style="margin-top:0; color: #4e73df;"><i class="fas fa-calculator"></i> Configuraci√≥n de Reporte Acumulado</h3>
            <p style="color: #666; font-size: 14px;">Defina el tope para calcular el acumulado de aportes por agente (ordenado por DNI).</p>
            
            <div style="display: flex; align-items: flex-end; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="display:block; font-weight: bold; margin-bottom: 8px; font-size: 13px;">VALOR DEL TOPE JUBILATORIO ($)</label>
                    <input type="number" id="input-tope-valor" value="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #eaecf4; border-radius: 8px; font-size: 18px; outline: none; transition: border-color 0.2s;">
                </div>
                
                <button id="btn-generar-acumulado" class="btn-convertir" style="margin-bottom: 0; height: 50px; padding: 0 30px; font-weight: bold;">
                    <i class="fas fa-play-circle"></i> GENERAR LISTADO
                </button>
            </div>
        </div>

        <div id="liquidacion-completa-view" class="container" style="display: none;">
            <h1 id="table-title">Cargando...</h1> <div id="table-status">Esperando comandos...</div>
            
            <div id="table-container">
                <div id="table-wrapper">
                    <table id="tabla-datos" class="display responsive nowrap" style="width:100%"></table> </div>
            </div>
        </div>



        </div>
        <!-- NUEVA SECCION-->>
        <div id="prueba-csv-view" class="container" style="display: none;">
            <h1>Prueba de PapaParse (Aislada)</h1>
            <div id="prueba-csv-output"></div>
        </div>
    </div>

    <script>
        const pruebaCsvView = document.getElementById('prueba-csv-view');
        const pruebaCsvOutput = document.getElementById('prueba-csv-output');
        const menuPruebaCsv = document.getElementById('menu-prueba-csv');
        // --- CONSTANTES Y ELEMENTOS ---
        const statusMessage = document.getElementById('status-message');
        const statusText = document.getElementById('status-text');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const loadingDots = document.getElementById('loading-dots');
        const sidebar = document.getElementById("mySidebar");
        const mainContent = document.getElementById("main-content");
        const sidebarWidth = '250px';

        const conversionForm = document.getElementById('conversion-form');
        const liquidacionView = document.getElementById('liquidacion-completa-view');
        const tableStatus = document.getElementById('table-status');





        let intervalId;
        const PHASES = ['', 'Ca', 'Carg', 'Carga', 'Cargand', 'Cargando'];


        // --- L√ìGICA VISTA ACUMULADO ---

        // 1. Manejo del Men√∫ Lateral
        const menuAcumulado = document.getElementById('menu-acumulado');
        if (menuAcumulado) {
            menuAcumulado.addEventListener('click', function(e) {
                e.preventDefault();
                console.log("‚úÖ Click en Men√∫: Cambiando a vista Acumulado");
                
                // Ocultar lo que no necesitamos
                document.getElementById('conversion-form').style.display = 'none';
                
                // Mostrar el panel de configuraci√≥n
                const panel = document.getElementById('panel-tope-jubilatorio');
                panel.style.display = 'block';
                
                // Ocultar tabla hasta que se genere
                document.getElementById('table-container').style.display = 'none';
                
                closeNav(); // Cierra sidebar
            });
        } 

        // 2. Manejo del Bot√≥n "GENERAR LISTADO"
        // index.html

        document.getElementById('btn-generar-acumulado').addEventListener('click', function() {
            console.log("üöÄ Paso 1: Generando archivo AcApJub.csv y visualizando...");
            
            // Mostramos la tabla y el t√≠tulo
            document.getElementById('table-container').style.display = 'block';
            
            // Llamamos al nuevo endpoint de preparaci√≥n
            const url = '/api/preparar-acumulado';
            loadDataAndRenderTable(url, "Vista Previa: AcApJub.csv (Estructura Base)");
        });

        /* if (btnGenerar) {
            console.log("üöÄ Listener del bot√≥n vinculado correctamente"); // Esto deber√≠a salir al cargar la p√°gina

            btnGenerar.addEventListener('click', function() {
                const topeValue = document.getElementById('input-tope-valor').value;
                console.log("‚ö° Bot√≥n Presionado. Valor del tope:", topeValue);

                if (topeValue === "" || parseFloat(topeValue) < 0) {
                    alert("‚ö†Ô∏è Por favor, ingrese un valor de tope v√°lido (mayor o igual a 0).");
                    return;
                }

                // Mostrar tabla y cargar
                document.getElementById('table-container').style.display = 'block';
                
                const url = `/api/acumulado-jubilatorio?tope=${topeValue}`;
                console.log("üåê Llamando a API:", url);
                
                loadDataAndRenderTable(url, `Acumulado Jubilatorio (Tope: $${topeValue})`);
            });
        } else {
            console.error("‚ùå ERROR: No se encontr√≥ el bot√≥n 'btn-generar-acumulado' en el HTML.");
        } */

        // --- FUNCIONES DE NAVEGACI√ìN ---
        function openNav() { sidebar.style.width = sidebarWidth; }
        function closeNav() { sidebar.style.width = '0'; }

        // --- Funciones de navegaci√≥n (modificar showSection) ---
        function showSection(sectionId) {
            conversionForm.style.display = 'none';
            liquidacionView.style.display = 'none';
            pruebaCsvView.style.display = 'none'; // Asegurar que la nueva vista est√© oculta

            if (sectionId === 'conversion-form') {
                conversionForm.style.display = 'block';
            } else if (sectionId === 'liquidacion-completa-view') {
                liquidacionView.style.display = 'block';
            } else if (sectionId === 'prueba-csv-view') { // NUEVA VISTA
                pruebaCsvView.style.display = 'block';
            }
        }
        
        // --- FUNCIONES DE ANIMACI√ìN Y STATUS ---
        function startLoadingAnimation() {
            let step = 0;
            statusText.textContent = 'Procesando archivos y unificando: ';
            loadingDots.style.display = 'inline';
            statusMessage.className = ''; 
            loadingDots.textContent = PHASES[0];

            intervalId = setInterval(() => {
                step = (step + 1) % PHASES.length;
                loadingDots.textContent = PHASES[step];
            }, 200);
        }

        function stopLoadingAnimation() {
            clearInterval(intervalId);
            loadingDots.style.display = 'none';
        }

        function mostrarStatus(message, type) {
            statusText.textContent = message;
            statusMessage.className = type === 'success' ? 'status-success' : 'status-error';
        }

        // --- L√ìGICA ETL ---
        function toggleUpload(isUpload) {
            uploadArea.style.display = isUpload ? 'block' : 'none';
        }

        async function iniciarProceso() {
            startLoadingAnimation();
            const selectedMode = document.querySelector('input[name="processMode"]:checked').value;
            const formData = new FormData();
            formData.append('processMode', selectedMode);

            if (selectedMode === 'upload') {
                if (fileInput.files.length === 0) {
                    stopLoadingAnimation();
                    mostrarStatus('Por favor, selecciona al menos un archivo Excel para cargar.', 'error');
                    return;
                }
                for (const file of fileInput.files) {
                    formData.append('excelFiles', file);
                }
            }

            try {
                const response = await fetch('/api/process', { method: 'POST', body: formData });
                const result = await response.json();
                
                stopLoadingAnimation();

                if (result.success) {
                    mostrarStatus(result.message, 'success');
                } else {
                    mostrarStatus(result.message, 'error');
                }
            } catch (error) {
                stopLoadingAnimation();
                mostrarStatus('Error de conexi√≥n con el servidor.', 'error');
            }
        }

        
        // --- FUNCI√ìN DE UTILIDAD: Esperar a que una variable exista ---
        function waitForPapaParse() {
            return new Promise((resolve, reject) => {
                // Chequea cada 100ms si PapaParse existe
                const checkInterval = setInterval(() => {
                    if (typeof PapaParse !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);

                // Seguridad: timeout de 5 segundos
                setTimeout(() => {
                    clearInterval(checkInterval);
                    reject(new Error("Timeout: La librer√≠a PapaParse no se carg√≥ despu√©s de 5 segundos."));
                }, 5000);
            });
        }

        // --- NUEVA FUNCI√ìN DE PRUEBA (Usa la espera) ---
        async function loadPruebaCsv() {
            showSection('prueba-csv-view');
            pruebaCsvOutput.innerHTML = '<h2>Ejecutando prueba (Esperando librer√≠a)...</h2>';

            try {
                await waitForPapaParse(); // üö® ESPERA ACTIVA AQU√ç

                const csvData = "columna_a,columna_b\r\nvalor1,valorA\r\nvalor2,valorB";

                const parsed = PapaParse.parse(csvData, {
                    header: true,
                    skipEmptyLines: true
                });

                pruebaCsvOutput.innerHTML = `
                    <h2>Resultado de PapaParse (√âxito):</h2>
                    <pre>${JSON.stringify(parsed.data, null, 2)}</pre>
                    <p>‚úÖ ¬°Funcionalidad PapaParse verificada!</p>
                `;

            } catch (error) {
                pruebaCsvOutput.innerHTML = `
                    <h2>Resultado de PapaParse (Falla Cr√≠tica):</h2>
                    <p style="color: red;">Error: ${error.message}</p>
                `;
            }
        }

            // --- L√ìGICA DE LA TABLA (Liquidaci√≥n Completa) ---
        let dataTableInitialized = false;

        function loadDataAndRenderTable(url, title) {
            console.log("üì• Iniciando carga desde:", url);
            
            // 1. Mostrar la vista y el t√≠tulo
            showSection('liquidacion-completa-view');
            const titleElement = document.getElementById('table-title');
            if (titleElement) titleElement.innerText = title;

            // 2. LIMPIEZA TOTAL: Evita el error de "Cannot reinitialise DataTable"
            const wrapper = document.getElementById('table-wrapper');
            if (wrapper) {
                wrapper.innerHTML = '<table id="tabla-datos" class="display responsive nowrap" style="width:100%"></table>';
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Error en el servidor: " + response.statusText);
                    return response.json();
                })
                .then(data => {
                    if (!data || data.length === 0) {
                        alert("No se encontraron registros para este reporte.");
                        return;
                    }

                    // 3. DETECCI√ìN DIN√ÅMICA DE COLUMNAS
                    const columns = Object.keys(data[0]).map(key => ({
                        title: key.replace(/_/g, ' '),
                        data: key
                    }));

                    // 4. INICIALIZACI√ìN
                    $('#tabla-datos').DataTable({
                        data: data,
                        columns: columns,
                        pageLength: 25,
                        responsive: true,
                        dom: 'Bfrtip',
                        buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
                        language: {
                            url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
                        }
                    });
                })
                .catch(error => {
                    console.error("‚ùå Error Cr√≠tico:", error);
                    alert("Hubo un fallo al cargar la tabla: " + error.message);
                });
        }    

        // --- AJUSTAR LA FUNCI√ìN ORIGINAL DE LIQUIDACI√ìN COMPLETA PARA USAR LA NUEVA FUNCI√ìN ---
        async function loadLiquidacionCompleta() {
            // Llama a la nueva funci√≥n gen√©rica con la URL y el t√≠tulo espec√≠ficos
            loadDataAndRenderTable('/api/liquidacion-completa', 'Liquidaci√≥n Completa Unificada');
        }
        
        // --- INICIALIZACI√ìN DE LA APLICACI√ìN ---
        // --- Modificaci√≥n en el DOMContentLoaded para asignar el evento ---
        document.addEventListener('DOMContentLoaded', () => {
            showSection('conversion-form');

            // Asignar evento a Liquidaci√≥n Completa (con la soluci√≥n de inicializaci√≥n segura)
            const menuLiquidacionCompleta = document.getElementById('menu-liquidacion-completa');
            if (menuLiquidacionCompleta) {
                menuLiquidacionCompleta.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    loadLiquidacionCompleta();
                    closeNav(); 
                });
            }
            // Conexi√≥n del men√∫ Residentes
            const menuResidentes = document.getElementById('menu-residentes');
            if (menuResidentes) {
                menuResidentes.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    // Llamamos a la funci√≥n gen√©rica de carga, pero le pasamos la URL del nuevo endpoint.
                    loadDataAndRenderTable('/api/residentes', 'Residentes Filtrados');
                    closeNav(); 
                });
            } else {
                console.error("Elemento 'menu-residentes' no encontrado.");
            }
            // Conexi√≥n del men√∫ Ley 100%
            const menuLey100 = document.getElementById('menu-ley100');
            if (menuLey100) {
                menuLey100.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    // Llama a la funci√≥n gen√©rica de carga con el nuevo endpoint y t√≠tulo.
                    loadDataAndRenderTable('/api/ley100', 'Liquidaciones Ley 100%');
                    closeNav(); 
                });
            } else {
                console.error("Elemento 'menu-ley100' no encontrado.");
            }
            // Asignar evento a la Prueba CSV Simple (NUEVO)
            if (menuPruebaCsv) {
                menuPruebaCsv.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadPruebaCsv();
                    closeNav();
                });
            }
        });
        // --- NUEVA FUNCI√ìN DE PRUEBA AS√çNCRONA ---
        
    </script>
</body>
</html>